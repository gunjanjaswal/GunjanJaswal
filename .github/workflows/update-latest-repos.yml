name: Update README with Latest Repositories

on:
  push:
    branches: [ main ]
  create:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update README with latest repos
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Fetch user's latest repositories
            const { data: repos } = await github.rest.repos.listForUser({
              username: 'gunjanjaswal',
              sort: 'updated',
              per_page: 10,
              type: 'owner'
            });
            
            // Filter out forks and get top 3 latest repos
            const latestRepos = repos
              .filter(repo => !repo.fork && !repo.archived)
              .slice(0, 3);
            
            // Generate project cards HTML
            const projectCards = latestRepos.map(repo => {
              const repoName = repo.name;
              const displayName = repoName
                .replace(/-/g, '_')
                .replace(/wordpress/gi, 'WordPress')
                .replace(/google/gi, 'Google')
                .replace(/news/gi, 'News')
                .replace(/sitemap/gi, 'Sitemap');
              
              const badgeText = displayName.replace(/_/g, ' ');
              const description = repo.description || `${repoName.replace(/-/g, ' ')} project`;
              
              return `    <td align="center">
      <a href="${repo.html_url}">
        <img src="https://img.shields.io/badge/${encodeURIComponent(badgeText)}-21759B?style=for-the-badge&logo=github&logoColor=white" alt="${badgeText}">
      </a>
      <p>${description}</p>
    </td>`;
            }).join('\n');
            
            // Read current README
            const readmePath = 'README.md';
            const readme = fs.readFileSync(readmePath, 'utf8');
            
            // Define the section to replace
            const startMarker = '<table>\n  <tr>';
            const endMarker = '  </tr>\n</table>';
            
            const startIndex = readme.indexOf(startMarker);
            const endIndex = readme.indexOf(endMarker, startIndex) + endMarker.length;
            
            if (startIndex === -1 || endIndex === -1) {
              console.log('Could not find table markers in README');
              return;
            }
            
            // Replace the table content
            const newTable = `<table>
  <tr>
${projectCards}
  </tr>
</table>`;
            
            const updatedReadme = readme.substring(0, startIndex) + newTable + readme.substring(endIndex);
            
            // Write updated README
            fs.writeFileSync(readmePath, updatedReadme);
            
            console.log('Updated README with latest repositories:', latestRepos.map(r => r.name));

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update README with latest repositories"
            git push
          fi
